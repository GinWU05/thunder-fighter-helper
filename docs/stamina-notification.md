# 体力通知功能 - 设计与技术讨论

## 目标
- 当“当前体力”达到“体力上限”时发送通知：`体力已满`
- 在满体力前 30 分钟发送通知：`将在30分钟后满体力`
- 提供设置项：`体力通知` 开/关
  - 关闭时：不发送通知，不保留后台机制

## 核心现实约束
- 浏览器网页 **无法可靠后台常驻运行**。
- 关闭页面后，前台定时器会停止。
- **后台通知必须依赖 Service Worker + Push 服务端**。
- Web Push 需要服务端 VAPID，且用户授权与浏览器支持都有限制。

## 结论（务实版）
- **无服务端**：只能实现“页面打开时”的通知（前台定时器）。
- **有服务端**：可实现“页面关闭后也能收到通知”（Push）。
- `service worker` 与后台通知“有关，但不是充分条件”：
  - SW 只是接收 Push 的执行环境，不会让页面常驻后台。

## 方案分级
### 方案 A：前台通知（无服务端）
- **优点**：实现简单、无额外基础设施。
- **缺点**：页面关闭后不会推送。
- **技术点**：
  - 用户开启“体力通知”后请求通知权限。
  - 计算 `满体力时间` 与 `提前30分钟时间`。
  - 在页面运行时用 `setTimeout` 触发通知。

### 方案 B：后台 Push（有服务端）
- **优点**：页面关闭也能推送。
- **缺点**：需要服务端、证书、推送订阅管理。
- **技术点**：
  - SW 监听 `push` 事件并显示通知。
  - 客户端把订阅信息传给服务端。
  - 服务端按用户时间计算并发送 push。

## 数据与时间计算
- 输入：
  - 当前体力 `current`
  - 体力上限 `max`
  - 当前时间 `now`
- 满体力时间：
  - 需要恢复的体力 `need = max - current`
  - 满体力时间 `fullTime = now + need * 5min`
- 提前 30 分钟时间：
  - `notifyTime = fullTime - 30min`
- 触发条件：
  - `current >= max`：立即可发送“体力已满”
  - `notifyTime > now`：设定提前提醒

## 设置项：体力通知
- 关闭：不请求权限、不设置定时器、不注册通知相关 SW。
- 开启：请求权限，成功后才安排通知。
- 若用户拒绝权限：提示并保持关闭状态。

## 兼容性与风险
- iOS Safari 对 Web Push 支持有限（需 PWA 安装，版本限制）。
- Android/桌面支持较好，但仍取决于权限与系统设置。
- 后台推送可能被系统省电策略延迟或限制。
- 时间计算需注意跨天（但此处计算只基于“满体力”即可）。

## 推荐实施路径（最小化改动）
1. 先实现 **方案 A**（前台通知 + 开关）。
2. 等确认需求与体验后，再评估是否引入 Push 服务端。
3. 若需要后台推送，再扩展 SW 与服务端。

## 与当前 PWA 关系
- 现有 `sw.js` 仅负责缓存，与通知无关。
- 若做后台推送，需要：
  - 在 SW 中新增 `push` 事件处理。
  - 客户端完成订阅上传。
  - 服务端定时发送 push。
